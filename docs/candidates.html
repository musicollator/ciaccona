<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DJBNRY1Z9M"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-DJBNRY1Z9M');
    </script>
    <meta charset="utf-8">
    <!-- meta name="viewport" content="width=device-width, initial-scale=1" -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="keywords" content="Bach, JSBach, J.S. Bach, BWV1004, BWV 1004, Partita, 2nd Partita, Ciaconna, Chaconne">
    <meta name="author" content="Christophe Thiebaud">

    <!-- HTML Meta Tags -->
    <title>Ciaccona - Performers & Candidates</title>
    <meta name="description" content="Performers plus Candidates to be included in the application">

    <!-- https://realfavicongenerator.net/ -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <!-- Facebook Meta Tags -->
    <meta property="fb:app_id" content="176898451849553">
    <meta property="og:locale" content="en_GB" />
    <meta property="og:site_name" content="ciaccona.cthiebaud.com" />
    <meta property="og:url" content="https://ciaccona.cthiebaud.com/candidates.html">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Ciaccona - Candidates">
    <meta property="og:description" content="Performers plus Candidates to be included in the application">
    <meta property="og:image" content="https://ciaccona.cthiebaud.com/screenshots/candidates.jpg" />
    <meta property="og:image:url" content="https://ciaccona.cthiebaud.com/screenshots/candidates.jpg" />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:image:width" content="612" />
    <meta property="og:image:height" content="408" />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@cthiebaud">
    <meta property="twitter:domain" content="ciaccona.cthiebaud.com">
    <meta property="twitter:url" content="https://ciaccona.cthiebaud.com/candidates.html">
    <meta name="twitter:title" content="Ciaccona - Candidates">
    <meta name="twitter:description" content="Performers plus Candidates to be included in the application">
    <meta name="twitter:image" content="https://ciaccona.cthiebaud.com/screenshots/candidates.jpg">

    <!-- Include Handlebars from a CDN -->
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <!-- bootstrap -->
    <link rel="stylesheet" href="/lib/bootstrap-5.2.3.min.css">

    <link rel="stylesheet" href="performers.css?v=1.0.4-beta.2">

    <style>
        tr.performer th,
        tr.performer td {
            color: gray !important;
        }
    </style>

</head>

<body id="body" class="d-flex flex-column">
    <script>

        function statusChangeCallback(response) {  // Called with the results from FB.getLoginStatus().
            console.log('statusChangeCallback');
            console.log(response);                   // The current login status of the person.
            if (response.status === 'connected') {   // Logged into your webpage and Facebook.
                testAPI();
            } else {                                 // Not logged into your webpage or we are unable to tell.
                // document.getElementById('status').innerHTML = 'Please log into this webpage.';
            }
        }


        function checkLoginState() {               // Called when a person is finished with the Login Button.
            FB.getLoginStatus(function (response) {   // See the onlogin handler
                statusChangeCallback(response);
            });
        }


        window.fbAsyncInit = function () {
            FB.init({
                appId: '176898451849553',
                cookie: true,                     // Enable cookies to allow the server to access the session.
                xfbml: true,                     // Parse social plugins on this webpage.
                version: 'v17.0'           // Use this Graph API version for this call.
            });


            FB.getLoginStatus(function (response) {   // Called after the JS SDK has been initialized.
                statusChangeCallback(response);        // Returns the login status.
            });
        };

        function testAPI() {                      // Testing Graph API after login.  See statusChangeCallback() for when this call is made.
            console.log('Welcome!  Fetching your information.... ');
            /*
            FB.api('/me', function (response) {
                console.log('Successful login for: ' + response.name);
                document.getElementById('status').innerHTML =
                    'Thanks for logging in, ' + response.name + '!';
            });
            */

            FB.api('/me', 'GET', {
                fields: 'first_name,last_name,name,id,email,picture.width(50).height(50)'
            }, function (response) {
                console.log(response);//Check the response in console
                document.getElementById('tronche').src = response.picture.data.url
                document.getElementById('tronche').title = response.name
            });
        }

    </script>

    <!-- The JS SDK Login Button -->

    <!-- Load the JS SDK asynchronously -->
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
</body>

<main id="candContainer" class="container-xxl">
    <header class="p-2" style="background-color: #f0f0f0; height: 6rem">
        <div style="float:right">
            <div style="border: 1px solid #d0d0d0; border-radius: .667rem; display:inline-block; padding:.4rem;">
                <fb:login-button scope="public_profile,email" onlogin="checkLoginState();" style="display:inline-block">
                </fb:login-button>

                <div style="display:inline-block" id="status">
                    <img id="tronche" src="/svg/face-with-a-question-mark-svgrepo-com.svg" style="width:32px; height:32px; border-radius:16px;">
                    <!-- /images/mexican-sugar-skull-small.jpeg -->
                </div>
            </div>
            <button id="go-back" type="button" class="btn btn-light m-0 p-0">
                <img src="index.svg?v=1.0.4-beta.2#close-circle-view" style="width:32px; height:32px;">
            </button>

        </div>
        <h1><span id="candidatesCount"></span> Performers & Candidates</h1>
    </header>
    <div id="candContainerRow" class="row" style="">
        <div id="candContainerCol" class="col">
            <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="true">
                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                    <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
                </div>
                <div class="carousel-inner">
                    <div class="carousel-item active" id="histoWrapper">
                    </div>
                    <div class="carousel-item" id="histoWrapper2">
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
            <table id="theTable" class="table table-fit table-responsive table-striped table-hover table-sm ">
                <caption style="width:100%" class="caption-top">
                </caption>
                <thead>
                    <tr style="font-size:smaller">
                        <!-- th scope="col" id="rownum" class="rownum">#</!-->
                        <th scope="col" id="name" class="name      text-center sortable">
                            <img src="svg/person-male-svgrepo-com.svg" style="width: 22px; height:22px;">
                            <span></span>
                        </th>
                        <th scope="col" class="views      text-start  sortable">Views <span></span></th>
                        <th scope="col" class="monthly    text-start  sortable" style="min-width: 6rem;">
                            Monthly
                            <span style="float: right;"></span>
                        </th>
                        <th scope="col" class="published text-start  sortable" colspan="2">Published on <span></span></th>
                        <th scope="col" class="yt        text-center">
                            <img src="svg/YouTube_social_white_square_(2017)_white_middle.svg" style="width: 22px; height:22px;">
                            <span></span>
                        </th>
                        <th scope="col" class="still text-start sortable">
                            <img src="svg/picture-svgrepo-com.svg" style="width: 22px; height:22px;">
                            <span style="width: 25px;"></span>
                        </th>
                        <th scope="col" class="instrument text-start  sortable">Instr.<span></span></th>
                        <th scope="col" class="flag      text-start  sortable">&nbsp;
                            <img src="svg/earth-svgrepo-com.svg" style="width: 22px; height:22px;">
                            <span style="width: 25px;"></span>
                        </th>
                    </tr>
                </thead>
                <tbody id="theBody">
                </tbody>
            </table>
        </div>
    </div>
</main>


<script id="candidate-template" type="text/x-handlebars-template">{{#each this}}        
<tr class="{{clazz}}">
<!-- th class="rownum">{{@index }}</!-->
<th class="name" data-lastname="{{reverseFullname}}" style="{{blockedStyle}}" title="{{blockedBy}}">
    {{#if performer}}    
        <a href="{{thisUrl}}" target="{{fullnameNospaceLowercaseNodiacritics}}">
            {{reverseFullname}}
        </a>
    {{else}}
        {{reverseFullname}}
    {{/if}}
</th>
<td class="views     text-end" data-number="{{v.views}}">{{numberFormat v.views}}</td>
<td class="monthly   text-end" data-number="{{v.viewsPerMonth}}">{{numberFormat v.viewsPerMonth}}</td>
<td class="published text-end" data-timestamp="{{dateFormat v.publishedMoment "YYMM"}}">{{dateFormat v.publishedMoment "MMMM YYYY"}}</td>
<td class="since" data-timestamp="{{dateFormat v.publishedMoment "YYMMDD"}}">{{humanize v.durationMoment}}</td>
<td class="yt        text-center"><a 
    href={{#if v.youtubeTrueUrl}}{{v.youtubeTrueUrl}}{{else}}{{v.youtubeUrl}}{{/if}}
    target={{fullnameNospaceLowercaseNodiacritics}}>
        {{#if v.trueId}}{{v.trueId}}{{else}}{{v.id}}{{/if}}
    </a></td>
<td class="still text-center">
    {{#if v.still}}
    <img src="svg/emoji-sad-circle-541-svgrepo-com.svg" style="width: 20px; height:20px;">
    {{else}}
    &nbsp;{{/if}}
</td>
<td class="instrument text-end">{{instrument}}</td>
<td class="flag text-center">{{flag}}</td>
</tr>{{/each}}</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>

<script async type="module">
    import jsYaml from 'https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/+esm'
    import lodashMerge from 'https://cdn.jsdelivr.net/npm/lodash.merge@4.6.2/+esm'
    import moment from 'https://cdn.jsdelivr.net/npm/moment@2.29.4/+esm'
    import { doHistogram } from '/histogram.js??v=1.0.4-beta.2'
    import { loadArtists } from "/js/artists.js?v=1.0.4-beta.2"

    const theDayWhenIReadTheVideoMeters = moment('2023-05-28T00:00:00Z')
    const now = moment()

    class Candidate {
        constructor(a) {
            lodashMerge(this, a)

            // https://stackoverflow.com/a/32906951/1070215
            this.fullname = [a.firstname, a.lastname].filter(Boolean).join(' ');
            this.fullnameNospace = this.fullname.replace(/\s/gi, '')
            this.fullnameNospaceLowercaseNodiacritics = this.fullnameNospace.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, '')
            this.reverseFullname = [a.lastname, a.firstname].filter(Boolean).join(', ');
            const vid = this['â–¶']
            vid.youtubeUrl = `https://youtu.be/${vid.id}`
            vid.publishedMoment = moment(vid.published)
            this.v = vid

            if (typeof this.blockedBy !== 'undefined') {
                this.blockedBy = `blocked by ${this.blockedBy}`
                this.blockedStyle = "text-decoration: line-through;"
            } else {
                this.blockedBy = ""
                this.blockedStyle = ""
            }

            if (true) { // calc viewsPerMonth ?
                let collected = theDayWhenIReadTheVideoMeters
                {
                    const duration = collected.diff(vid.publishedMoment)
                    const durationMoment = moment.duration(duration)
                    vid.viewsPerMonth = Math.floor(vid.views / durationMoment.asMonths())
                }

                vid.duration = now.diff(vid.publishedMoment)
                vid.durationMoment = moment.duration(vid.duration)
            }
            this.views = vid.views
            this.viewsPerMonth = vid.viewsPerMonth
        }
    }

    document.getElementById("go-back").addEventListener("click", () => {
        const tronche = document.getElementById('tronche')
        if (tronche.src.endsWith("face-with-a-question-mark-svgrepo-com.svg")) {
            window.location = document.referrer
        } else {
            FB.logout(function (response) {
                window.location = document.referrer
            });
        }
    });

    const ff = new Intl.NumberFormat()

    Handlebars.registerHelper('dateFormat', function (object, formatting) {
        return object.format(formatting)
    })
    Handlebars.registerHelper('humanize', function (object) {
        return object.humanize()
    })
    Handlebars.registerHelper('numberFormat', function (object) {
        return ff.format(object)
    })

    const source = document.getElementById("candidate-template").innerHTML;
    const template = Handlebars.compile(source);

    const candidates = []
    const urlCandidatesYAML = "/_candidates.yaml"
    const candidatesRequest = new Request(urlCandidatesYAML);
    fetch(candidatesRequest, { cache: "no-store" }).then((response) => {
        if (!response.ok) {
            throw new Error(`HTTP error fetching ${urlCandidatesYAML}! Status: ${response.status}`);
        }
        return response.text()
    }).then((candidatesAsYAMLText) => {

        const candidatesAsJSONObject = jsYaml.load(candidatesAsYAMLText)
        candidatesAsJSONObject.forEach((c) => {
            const cand = new Candidate(c)
            cand.clazz = 'candidate'
            candidates.push(cand)
        })

        console.log('# candidates', candidates.length)

        loadArtists().then((theArtists) => {
            theArtists.artists.forEach(a => {
                const perf = new Candidate(a)
                perf.clazz = 'performer'
                perf.performer = true
                candidates.push(perf)
            })

            candidates.sort((a, b) => a.reverseFullname.localeCompare(b.reverseFullname))
            const bodyContent = template(candidates)
            theBody.innerHTML = bodyContent
            document.getElementById('candidatesCount').innerHTML = candidates.length

            const rect = document.getElementById('histoWrapper').getBoundingClientRect()

            const formatViewsPerMonthTick = (d) => {
                if (d >= 1000) {
                    return String(Math.floor(d / 1000)) + 'k'
                } else {
                    return d
                }
            }

            doHistogram({
                idWrapper: 'histoWrapper',
                key: "viewsPerMonth",
                formatKey: d => d,
                formatTick: formatViewsPerMonthTick,
                thresholds: 240,
                durations: candidates,
                log: false
            })
            doHistogram({
                idWrapper: 'histoWrapper2',
                key: "viewsPerMonth",
                formatKey: d => d,
                formatTick: formatViewsPerMonthTick,
                thresholds: 240,
                durations: candidates,
                log: true
            })
        })
    }).catch((error) => {
        console.log("script loading error", urlCandidatesYAML, error);
    })

</script>

<script src="performers.js"></script>

</body>

</html>