<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DJBNRY1Z9M"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-DJBNRY1Z9M');
    </script>
    <meta charset="utf-8">
    <!-- meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" -->
    <meta name="keywords" content="Bach, JSBach, J.S. Bach, BWV1004, BWV 1004, Partita, 2nd Partita, Ciaconna, Chaconne, Puzzle">
    <meta name="author" content="Christophe Thiebaud">

    <!-- HTML Meta Tags -->
    <title>Ciaccona - Puzzle</title>
    <meta name="description" content="Puzzle">

    <!-- https://realfavicongenerator.net/ -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <style>
        * {
            box-sizing: border-box;
        }

        body#body {
            font-family: sans-serif;
            /* background: #DDD; */
            background-color: #333;
            color: #555;
            text-align: center;
            padding-bottom: 50px;
            margin: 0;
            padding: 0;
            width: 100%;
        }

        a {
            color: #19F;
        }

        a:hover {
            color: #C25;
        }

        .grid {
            width: 1200px;
            min-width: 1200px;
            background-color: #333;
            /* margin: 50px auto; */
            min-height: 628px;
            z-index: 2;
            transform-origin: top center;
        }

        .tile {
            float: left;
            width: 150px;
            height: 157px;
            transition: '.333s';

            /*   border: 1px solid; */
            background-color: #333;
            /* background-image: url('https://musicollator.github.io/ciaccona-stationary/artists/martinbaker/martinbaker-10.jpg'); */
            cursor: move;
        }

        .tile.w2 {
            width: 200px;
        }

        .tile.h2 {
            height: 200px;
        }

        .tile.bgx1 {
            background-position-x: -150px;
        }

        .tile.bgx2 {
            background-position-x: -300px;
        }

        .tile.bgx3 {
            background-position-x: -450px;
        }

        .tile.bgx4 {
            background-position-x: -600px;
        }

        .tile.bgx5 {
            background-position-x: -750px;
        }

        .tile.bgx6 {
            background-position-x: -900px;
        }

        .tile.bgx7 {
            background-position-x: -1050px;
        }

        .tile.bgy1 {
            background-position-y: -157px;
        }

        .tile.bgy2 {
            background-position-y: -314px;
        }

        .tile.bgy3 {
            background-position-y: -471px;
        }

        .tile:hover {
            outline: 5px solid hsla(210, 100%, 50%, 0.7);
            outline-offset: -5px;
            z-index: 2;
        }

        .tile.is-dragging,
        .tile.is-positioning-post-drag {
            outline: none;
            z-index: 2;
            opacity: 0.8;
        }

        .packery-drop-placeholder {
            outline: 3px dashed white;
            outline-offset: -6px;
            transition: transform 0.2s;
        }

        /* -------- */

        .dialog-container {
            width: 600px;
            margin: 0 auto;
            position: relative;
        }

        .dialog {
            position: absolute;
            padding: 20px;
            width: 100%;
            background: #333;
            color: white;
            border-radius: 20px;
            text-align: center;
            font-size: 28px;
            box-shadow: 0 5px 10px hsla(0, 0%, 0%, 0.4);
            z-index: 10;
            transition: opacity 0.2s, transform 0.2s;
        }

        .dialog.is-waiting {
            pointer-events: none;
            opacity: 0;
            transform: translateY(100px);
        }

        .dialog b {
            color: #EA0;
        }

        .nesw.up,
        .nesw.down {
            padding: 0;
            border-radius: 0 !important;
        }

        .nesw.left {
            border-top-left-radius: 4rem;
            border-bottom-left-radius: 4rem;
            border-bottom-right-radius: 0;
            border-top-right-radius: 0;
            padding-left: 0.2rem;
            padding-right: 0.2rem;
            max-width: 48px;
        }

        .nesw.right {
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-top-right-radius: 4rem;
            border-bottom-right-radius: 4rem;
            padding: 0;
            padding-left: 0.2rem;
            padding-right: 0.2rem;
            max-width: 48px;
        }

        #name {
            padding: 0.666rem;
            background-color: #333;
            border-right: 2px solid gray;
            white-space: nowrap;
            width: fit-content;
        }

        #nameHolder {
            min-width: 240px;
            top: 0;
            bottom: 0;
            margin-top: auto;
            margin-bottom: auto;
        }

        #vari {
            margin: auto;
            padding: 0.666rem;
            border-top-left-radius: 1rem;
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
            border-top-right-radius: 1rem;
            background-color: #333;
            min-width: 40px;
        }
    </style>

    <!-- bootstrap -->
    <link rel="stylesheet" href="/lib/bootstrap-5.2.3.min.css">

</head>

<body id="body">
    <main id="perfContainer">
        <div class="d-flex flex-column" style="width:fit-content; margin:auto;">
            <div class="dialog-container">
                <div class="dialog is-waiting">
                    <p class="dialog__text">&nbsp;</p>
                    <div>
                        <button type="button" class="btn btn-secondary try-again-button">Try again</button>
                        <button type="button" class="btn btn-secondary close-dialog-button">Close</button>
                    </div>
                </div>
            </div>

            <div class="d-flex" style="margin:2rem; position:relative;">
                <button id="go-back" type="button" class="btn btn-light m-0 p-0" style="position: absolute; right:0; top:0; z-index: 2;">
                    <img src="index.svg?v=0.13.3#close-circle-view" style="width:32px; height:32px;">
                </button>

                <div class="flex-grow-1 d-flex">
                    <button type="button" class="btn btn-secondary nesw left text-center align-middle" id="left">&lArr;</button>
                    <div class="d-flex flex-column" style="background-color: #6c757d;">
                        <button type="button" class="btn btn-secondary nesw up text-center align-middle" id="up">&uArr; </button>
                        <div class="d-flex" style="background-color: #6c757d;">
                            <div id="vari" class="text-light" style=""></div>
                        </div>
                        <button type="button" class="btn btn-secondary nesw down text-center align-middle" id="down">&dArr;</button>
                    </div>
                    <button type="button" class="btn btn-secondary nesw right text-center align-middle" id="right">&rArr;</button>
                    <div id="nameHolder">
                        <div id="name" class="name text-light" style="text-align: left;"></div>
                    </div>
                </div>
                <div class="m-3">
                    <h2 class="text-light" style="text-align: left;">
                        <span id="artistsWithVidCount">a</span>
                        Artists
                        <img src="svg/math-multiplication-icon.svg" style="width:22px; height:auto;">
                        <span id="variationsCount">v</span>
                        Variations
                        <img src="svg/equals-symbol-svgrepo-com.svg" style="width:22px; height:auto;">
                        <span id="puzzlesCount">v</span> Puzzles</a>
                    </h2>
                </div>
                <button type="button" class="btn btn-primary shuffle-button" style="margin-right: 40px;">Shuffle</button>
            </div>
            <div id="grid" class="grid" style="margin:auto;">
                <div data-tile="a" class="tile     "></div>
                <div data-tile="b" class="tile bgx1"></div>
                <div data-tile="c" class="tile bgx2"></div>
                <div data-tile="d" class="tile bgx3"></div>
                <div data-tile="e" class="tile bgx4"></div>
                <div data-tile="f" class="tile bgx5"></div>
                <div data-tile="g" class="tile bgx6"></div>
                <div data-tile="h" class="tile bgx7"></div>
                <div data-tile="i" class="tile       bgy1"></div>
                <div data-tile="j" class="tile bgx1  bgy1"></div>
                <div data-tile="k" class="tile bgx2  bgy1"></div>
                <div data-tile="l" class="tile bgx3  bgy1"></div>
                <div data-tile="m" class="tile bgx4  bgy1"></div>
                <div data-tile="n" class="tile bgx5  bgy1"></div>
                <div data-tile="o" class="tile bgx6  bgy1"></div>
                <div data-tile="p" class="tile bgx7  bgy1"></div>
                <div data-tile="q" class="tile       bgy2"></div>
                <div data-tile="r" class="tile bgx1  bgy2"></div>
                <div data-tile="s" class="tile bgx2  bgy2"></div>
                <div data-tile="t" class="tile bgx3  bgy2"></div>
                <div data-tile="u" class="tile bgx4  bgy2"></div>
                <div data-tile="v" class="tile bgx5  bgy2"></div>
                <div data-tile="w" class="tile bgx6  bgy2"></div>
                <div data-tile="x" class="tile bgx7  bgy2"></div>
                <div data-tile="y" class="tile       bgy3"></div>
                <div data-tile="z" class="tile bgx1  bgy3"></div>
                <div data-tile="0" class="tile bgx2  bgy3"></div>
                <div data-tile="1" class="tile bgx3  bgy3"></div>
                <div data-tile="2" class="tile bgx4  bgy3"></div>
                <div data-tile="3" class="tile bgx5  bgy3"></div>
                <div data-tile="4" class="tile bgx6  bgy3"></div>
                <div data-tile="5" class="tile bgx7  bgy3"></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { theTrickToViewportUnitsOnMobile } from '/js/utils.js?v=0.13.3'
        function scaleGrid() {
            const vw = window.innerWidth
            const vh = window.innerHeight

            const scaleX = window.innerWidth / 1200
            const scaleY = window.innerHeight / 628
            const min = Math.min(scaleX, scaleY) * .9
            if (min < 1) { // only zoom out, never zoom in
                const qwe = `scale(${min})`

                console.log(qwe)
                document.getElementById('grid').style.transform = qwe
            }
        }
        window.addEventListener("DOMContentLoaded", (event) => {
            scaleGrid()
        }, { once: true });

        theTrickToViewportUnitsOnMobile(true, () => scaleGrid())
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script async type="module">
        // https://codepen.io/desandro/pen/eJXRbW
        import packeryLayout from 'https://cdn.jsdelivr.net/npm/packery@2.1.2/+esm'
        import Draggabilly from 'https://cdn.jsdelivr.net/npm/draggabilly@3.0.0/+esm'
        import { shuffleArray } from "/js/utils.js?v=0.13.3"
        import { loadArtists } from "/js/artists.js?v=0.13.3"
        import codec from "/js/structure.js?v=0.13.3"

        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop)
        })
        let coerceArtist = params.a ?? undefined
        let coerceVariation = params.v ?? undefined

        document.getElementById("go-back").addEventListener("click", () => {
            window.location = document.referrer
        });

        var grid = document.querySelector('.grid');
        var pckry = new packeryLayout(grid, {
            itemSelector: '.tile',
            columnWidth: 150,
            transitionDuration: '0.3s'
        });

        pckry.getItemElements().forEach(function (itemElem) {
            var draggie = new Draggabilly(itemElem);
            pckry.bindDraggabillyEvents(draggie);
        });

        // map items by their data-tile
        var mappedItems = {};

        pckry.items.forEach(function (item) {
            var attr = item.element.getAttribute('data-tile');
            mappedItems[attr] = item;
        });

        function qwe() {
            console.log('clicked!')
        }

        loadArtists().then((artists) => {

            const artistsWithVid = shuffleArray(artists.artists.filter(a => !a.v.still))
            const artistsWithVidCount = artistsWithVid.length
            const variationsCount = codec.variationsCount
            const puzzlesCount = codec.variationsCount * artistsWithVid.length

            document.getElementById('artistsWithVidCount').innerHTML = artistsWithVidCount
            document.getElementById('variationsCount').innerHTML = variationsCount
            document.getElementById('puzzlesCount').innerHTML = puzzlesCount

            let v = coerceVariation ?? 0
            let a = 0
            if (coerceArtist) {
                for (a = 0; a < artistsWithVid.length; a++) {
                    if (artistsWithVid[a].fullnameNoSpaceLowercaseNoDiacritics === coerceArtist) {
                        break;
                    }
                }
            }
            if (a < 0 || artistsWithVid.length <= a) {
                alert(`no puzzle for ${coerceArtist}`)
                a = 0
            }
            function setImageAndName(a, v) {
                document.getElementById('name').innerHTML = a.fullname
                document.getElementById('vari').innerHTML = v
                document.querySelectorAll('.tile').forEach(t => {
                    t.style.backgroundImage = `url(https://musicollator.github.io/ciaccona-stationary/artists/${a.fullnameNoSpaceLowercaseNoDiacritics}/${a.fullnameNoSpaceLowercaseNoDiacritics}-${v}.jpg)`
                })
            }
            setImageAndName(artistsWithVid[a], v)

            document.querySelectorAll('#up, #down, #left, #right').forEach(e => e.addEventListener("click", () => {
                console.log(e.id)
                switch (e.id) {
                    case 'up':
                        a = (a + (artistsWithVid.length - 1)) % artistsWithVid.length
                        break;
                    case 'down':
                        a = (a + 1) % artistsWithVid.length
                        break;
                    case 'left':
                        v = (v + variationsCount - 1) % variationsCount
                        break;
                    case 'right':
                        v = (v + 1) % variationsCount
                        break;
                    default:
                        console.log(`Sorry, we are out of ${e.id}.`);
                }
                setImageAndName(artistsWithVid[a], v)
            }))
            function shuffleTiles() {
                // shuffle items
                pckry.items = shuffleArray(pckry.items)
                // stagger transition
                pckry._resetLayout();
                pckry.items.forEach(function (item, i) {
                    setTimeout(function () {
                        pckry.layoutItems([item]);
                    }, i++ * variationsCount);
                });
            }

            var dialog = document.querySelector('.dialog');
            var didWin = false;

            function win() {
                if (!didWin) {
                    document.querySelector('.dialog__text').innerHTML = 'Nice work!<br>';
                }
                didWin = true;
                showDialog();
            }


            function showDialog() {
                dialog.classList.remove('is-waiting');
            }

            function hideDialog() {
                dialog.classList.add('is-waiting');
            }

            dialog.querySelector('.try-again-button').onclick = function () {
                hideDialog();
                shuffleTiles();
            }

            dialog.querySelector('.close-dialog-button').onclick = hideDialog;

            document.querySelector('.shuffle-button').onclick = shuffleTiles;

            pckry.on('dragItemPositioned', function () {
                var order = pckry.items.map(function (item) {
                    return item.element.getAttribute('data-tile');
                }).join('');
                if (pckry.maxY == 628 && order == 'abcdefghijklmnopqrstuvwxyz012345') {
                    win();
                }
            });
        });
    </script>

</body>

</html>